@prefix sh:   <http://www.w3.org/ns/shacl#> .
@prefix ecfo: <https://w3id.org/ecfo#> .
@prefix peco: <https://w3id.org/peco#> .
@prefix qudt: <http://qudt.org/schema/qudt/> .

ecfo:EmissionConversionFactorShape
    a              sh:NodeShape ;
    sh:targetClass ecfo:EmissionConversionFactor ;
    sh:property    [ sh:path     ecfo:hasSourceUnit ;
                     sh:minCount 1 ;
                     sh:maxCount 1 ;
                     sh:severity sh:Violation ;
                     sh:message  "An emission conversion factor should have exactly 1 source unit" ] ;
    sh:property    [ sh:path     ecfo:hasSourceUnit ;
                     sh:class    qudt:Unit ;
                     sh:severity sh:Violation ;
                     sh:message  "An emission conversion factor's source units are not of type qudt:Unit" ; ] ;
    sh:property    [ sh:path     ecfo:hasTargetUnit ;
                     sh:minCount 1 ;
                     sh:maxCount 1 ;
                     sh:severity sh:Violation ;
                     sh:message  "An emission conversion factor should have exactly 1 target unit" ] ;
    sh:property    [ sh:path     ecfo:hasTargetUnit ;
                     sh:class    qudt:Unit ;
                     sh:severity sh:Violation ;
                     sh:message  "An emission conversion factor's target units are not of type qudt:Unit" ; ] ;
    sh:property    [ sh:path     ecfo:hasApplicableLocation ;
                     sh:minCount 1 ;
                     sh:maxCount 1 ;
                     sh:severity sh:Warning ;
                     sh:message  "An emission conversion factor should have exactly 1 applicable location" ] ;
    sh:property    [ sh:path     peco:scope ;
                     sh:in       ( ecfo:Scope1 ecfo:Scope2 ecfo:Scope3 ) ;
                     sh:severity sh:Violation ;
                     sh:message  "An emission conversion factor's scope should be Scope1, Scope2 or Scope3" ; ] ;
    sh:property    [ sh:path     ecfo:hasEmissionTarget ;
                     sh:minCount 1 ;
                     sh:maxCount 1 ;
                     sh:severity sh:Violation ;
                     sh:message  "An emission conversion factor should have exactly 1 emission target" ; ] ;
    sh:property    [ sh:path     ecfo:hasEmissionTarget ;
                     sh:class    qudt:QuantityKind ;
                     sh:severity sh:Violation ;
                     sh:message  "Emission conversion factor's emission target should be of type qudt:QuantityKind" ; ] ;
    sh:sparql      [ sh:severity sh:Violation ;
                     sh:message  "An emission calculation activity that involved a CF used entities with non-matching units" ;
                     sh:select   """
                     PREFIX peco: <https://w3id.org/peco#>
                     PREFIX prov: <http://www.w3.org/ns/prov#>
                     PREFIX ecfo: <https://w3id.org/ecfo#>
                     PREFIX qudt: <http://qudt.org/schema/qudt/>
                     SELECT ?cf ?activity ?cfUnit ?entityUnit
                     WHERE {
                        ?cf a ecfo:EmissionConversionFactor ;
                                ecfo:hasSourceUnit ?cfUnit .
                        ?activity a peco:EmissionCalculationActivity ;
                                prov:used ?cf, ?entity .
                        ?entity a peco:EmissionCalculationEntity ;
                                qudt:unit ?entityUnit .
                        FILTER(?cfUnit != ?entityUnit)
                     }
                     """ ] .