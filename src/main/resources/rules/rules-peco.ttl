@prefix sh:   <http://www.w3.org/ns/shacl#> .
@prefix rdf:  <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix qudt: <http://qudt.org/schema/qudt/> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix prov: <http://www.w3.org/ns/prov#> .
@prefix ecfo: <https://w3id.org/ecfo#> .
@prefix peco: <https://w3id.org/peco#> .

peco:EmissionGenerationActivityShape
    a              sh:NodeShape ;
    sh:targetClass peco:EmissionGenerationActivity ;
    sh:property    [ sh:path     peco:hasEmissionScore ;
                     sh:minCount 1 ;
                     sh:maxCount 1 ;
                     sh:severity sh:Warning ;
                     sh:message  "An emission generation activity should have exactly one emission score" ; ] ;
    sh:property    [ sh:path     peco:hasEmissionScore ;
                     sh:and      ( [ sh:class peco:EmissionScore ] [ sh:class peco:EmissionCalculationEntity ] ) ;
                     sh:severity sh:Warning ;
                     sh:message  "An emission score should be of type peco:EmissionScore and peco:EmissionCalculationEntity" ; ] ;
    sh:sparql      [ sh:severity sh:Warning ;
                     sh:message  "An emission generation activity should have happened at CF's applicable location" ;
                     sh:select   """
                     PREFIX peco: <https://w3id.org/peco#>
                     PREFIX prov: <http://www.w3.org/ns/prov#>
                     PREFIX ecfo: <https://w3id.org/ecfo#>
                     PREFIX geo: <http://www.opengis.net/ont/geosparql#>
                     SELECT ?ehContainsLocation ?cfLocation ?activityAtLocation
                     WHERE {
                        ?activity a peco:EmissionGenerationActivity ;
                                prov:atLocation ?activityAtLocation .
                        OPTIONAL {
                            ?activityAtLocation a geo:SpatialObject ;
                                    geo:ehContains ?ehContainsLocation .
                        }
                        ?cf a ecfo:EmissionConversionFactor ;
                                ecfo:hasApplicableLocation ?cfLocation .
                        BIND(IF(BOUND(?ehContainsLocation), ?ehContainsLocation, ?activityAtLocation) AS ?locationToCheck)
                        FILTER(?locationToCheck != ?cfLocation)
                     }
                     """ ] .

peco:EmissionCalculationActivityShape
    a              sh:NodeShape ;
    sh:targetClass peco:EmissionCalculationActivity ;
    sh:property    [ sh:path     prov:used ;
                     sh:minCount 2 ;
                     sh:severity sh:Warning ;
                     sh:message  "An emission calculation activity should involve at least 2 things" ; ] ;
    sh:property    [ sh:path                prov:used ;
                     sh:qualifiedMinCount   1 ;
                     sh:qualifiedValueShape [ sh:class peco:EmissionCalculationEntity ; ] ;
                     sh:severity            sh:Warning ;
                     sh:message             "An emission calculation activity should involve at least one peco:EmissionCalculationEntity" ; ] ;
    sh:sparql      [ sh:message  "The units used in peco:EmissionCalculationActivity are different" ;
                     sh:severity sh:Warning ;
                     sh:select   """
                     PREFIX peco: <https://w3id.org/peco#>
                     PREFIX prov: <http://www.w3.org/ns/prov#>
                     PREFIX ecfo: <https://w3id.org/ecfo#>
                     PREFIX qudt: <http://qudt.org/schema/qudt/>
                     SELECT ?activity ?calculationEntityUnit ?cfUnit
                     WHERE {
                        ?activity prov:used ?usedEntities .
                        {
                            SELECT ?activity ?calculationEntityUnit ?cfUnit
                            WHERE {
                                ?activity prov:used ?calculationEntity, ?cf .
                                ?calculationEntity a peco:EmissionCalculationEntity ;
                                        qudt:unit ?calculationEntityUnit .
                                ?cf a ecfo:EmissionConversionFactor ;
                                        ecfo:hasSourceUnit ?cfUnit .
                            }
                        }
                        FILTER NOT EXISTS {
                            ?activity prov:used ?calculationEntity .
                            ?activity prov:used ?cf .
                            FILTER(?calculationEntity != ?cf)
                        }
                        FILTER(?calculationEntityUnit != ?cfUnit)
                     }
              """ ; ] .

peco:EmissionCalculationEntityShape
    a              sh:NodeShape ;
    sh:targetClass peco:EmissionCalculationEntity ;
    sh:sparql      [ sh:message "The observed unit is not applicable for the observed quantity kind" ;
                     sh:select  """
                     PREFIX qudt: <http://qudt.org/schema/qudt/>
                     PREFIX peco: <https://w3id.org/peco#>
                     SELECT ?unit
                     WHERE {
                         ?entity qudt:hasQuantityKind ?quantityKind ;
                                 qudt:unit ?unit .
                         ?quantityKind qudt:applicableUnit ?applicableUnit .
                         ?applicableUnit qudt:unit ?unit .
                     }
                    """ ; ] ;
    sh:property    [ sh:path     prov:wasGeneratedBy ;
                     sh:class    peco:EmissionCalculationActivity ;
                     sh:severity sh:Warning ;
                     sh:message  "An emission calculation entity must have been generated by peco:EmissionCalculationActivity" ; ] ;
    sh:sparql      [ sh:severity sh:Warning ;
                     sh:message  "An emission calculation entity must have been generated by a unique activity." ;
                     sh:select   """
                     PREFIX peco: <https://w3id.org/peco#>
                     PREFIX prov: <http://www.w3.org/ns/prov#>
                     PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
                     SELECT DISTINCT $this ?value ?other
                     WHERE {
                         $this prov:wasGeneratedBy ?value .
                         ?other prov:wasGeneratedBy ?value .
                         FILTER (?other != $this) .
                         ?other a/rdfs:subClassOf* peco:EmissionCalculationEntity .
                     }
                     """ ; ] .

peco:EmissionScoreShape
    a              sh:NodeShape ;
    sh:targetClass peco:EmissionScore ;
    sh:sparql      [ sh:severity sh:Warning ;
                     sh:message  "The quantity kind of the emission score is not compatible with the CF's target chemical compound" ;
                     sh:select   """
                     PREFIX peco: <https://w3id.org/peco#>
                     PREFIX qudt: <http://qudt.org/schema/qudt/>
                     PREFIX ecfo: <https://w3id.org/ecfo#>
                     SELECT ?scoreQuantityKind ?cfEmissionTarget
                     WHERE {
                        ?emissionScore a peco:EmissionScore ;
                                qudt:hasQuantityKind ?scoreQuantityKind .
                        ?cf a ecfo:EmissionConversionFactor ;
                                ecfo:hasEmissionTarget ?cfEmissionTarget .
                        FILTER(?scoreQuantityKind != ?cfEmissionTarget)
                     }
                     """ ] ;
    sh:sparql      [ sh:severity sh:Warning ;
                     sh:message  "The units of the emission score are not compatible with the CF's target units" ;
                     sh:select   """
                     PREFIX peco: <https://w3id.org/peco#>
                     PREFIX qudt: <http://qudt.org/schema/qudt/>
                     PREFIX ecfo: <https://w3id.org/ecfo#>
                     SELECT ?scoreUnit ?cfUnit
                     WHERE {
                        ?emissionScore a peco:EmissionScore ;
                                qudt:unit ?scoreUnit .
                        ?cf a ecfo:EmissionConversionFactor ;
                                ecfo:hasTargetUnit ?cfUnit .
                        FILTER(?scoreUnit != ?cfUnit)
                     }
                   """ ; ] .